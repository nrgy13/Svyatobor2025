# План тестирования формы обратной связи через n8n

## Цель тестирования
Полная проверка работоспособности формы обратной связи на сайте святобор.online, включая интеграцию с n8n webhook и получение уведомлений в Telegram.

## Предварительные проверки

### 1. Проверка переменных окружения
**Действия:**
- Убедитесь, что в GitHub Secrets настроены следующие переменные:
  - `NEXT_PUBLIC_N8N_WEBHOOK_URL` - URL n8n webhook
  - `TELEGRAM_BOT_TOKEN` - токен бота
  - `TELEGRAM_CHAT_ID` - ID чата для уведомлений

**Ожидаемый результат:** Деплой проходит успешно, сайт доступен

---

## ЧАСТЬ 1: Тестирование API Route

### 2. Проверка доступности API
**URL:** `https://святобор.online/api/contact`

**Тест 2.1: OPTIONS запрос (CORS)**
```bash
curl -X OPTIONS https://святобор.online/api/contact \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type" \
  -v
```

**Ожидаемый результат:**
- Статус: 200
- Заголовки CORS присутствуют:
  - `Access-Control-Allow-Origin: *`
  - `Access-Control-Allow-Methods: POST, OPTIONS`
  - `Access-Control-Allow-Headers: Content-Type`

---

**Тест 2.2: POST запрос с валидными данными**
```bash
curl -X POST https://святобор.online/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тестовый пользователь",
    "phone": "+79991234567",
    "email": "test@example.com",
    "service": "Удаление деревьев",
    "address": "г. Краснодар, ул. Тестовая, 1",
    "message": "Тестовое сообщение для проверки работы формы",
    "preferredTime": "с 10:00 до 18:00"
  }' \
  -v
```

**Ожидаемый результат:**
- Статус: 200
- Ответ содержит:
  ```json
  {
    "success": true,
    "message": "Заявка успешно отправлена! Мы свяжемся с вами в ближайшее время."
  }
  ```

---

**Тест 2.3: POST запрос без обязательных полей**
```bash
curl -X POST https://святобор.online/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "+79991234567"
  }' \
  -v
```

**Ожидаемый результат:**
- Статус: 400
- Ответ содержит ошибку:
  ```json
  {
    "error": "Имя и телефон обязательны для заполнения"
  }
  ```

---

**Тест 2.4: POST запрос с коротким номером телефона**
```bash
curl -X POST https://святобор.online/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тест",
    "phone": "+7999"
  }' \
  -v
```

**Ожидаемый результат:**
- Статус: 400
- Ответ содержит ошибку:
  ```json
  {
    "error": "Введите корректный номер телефона"
  }
  ```

---

**Тест 2.5: POST запрос с невалидным email**
```bash
curl -X POST https://святобор.online/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тест",
    "phone": "+79991234567",
    "email": "invalid-email"
  }' \
  -v
```

**Ожидаемый результат:**
- Статус: 400
- Ответ содержит ошибку:
  ```json
  {
    "error": "Введите корректный email"
  }
  ```

---

**Тест 2.6: POST запрос с максимально допустимыми данными**
```bash
curl -X POST https://святобор.online/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "А",
    "phone": "+7999123456",
    "email": "test@example.com",
    "service": "Вывоз растительных остатков",
    "objectType": "Частный дом",
    "address": "г. Новороссийск, ул. Длинная, 999",
    "message": "Максимально длинное сообщение для проверки ограничений на стороне сервера и клиента. Здесь должно быть описание задачи клиента, которое может быть достаточно объёмным, но при этом не должно превышать разумных пределов, которые обычно устанавливаются в веб-формах и системах обработки заявок.",
    "preferredTime": "с 9:00 до 21:00"
  }' \
  -v
```

**Ожидаемый результат:**
- Статус: 200
- Ответ содержит успех

---

## ЧАСТЬ 2: Тестирование интеграции с n8n

### 3. Проверка логов n8n
**Действия:**
1. Войдите в панель n8n (https://n8n.lex1case.ru)
2. Перейдите в раздел "Executions" (Выполнения)
3. Ожидайте отправку тестовой заявки с сайта
4. Проверьте, что заявка появилась в списке выполнений

**Ожидаемый результат:**
- Заявка от сайта отображается в n8n
- Статус выполнения: "success" (успешно)
- Данные в заявке соответствуют отправленным

---

### 4. Проверка webhook в n8n
**Действия:**
1. В n8n найдите рабочий процесс, который обрабатывает webhook
2. Нажмите на webhook и проверьте настройки:
   - Method: POST
   - Path: `/webhook/svyatobor-zayavki`
   - Authentication (если настроена)
   - Response Mode: `on received` (отправлять ответ клиенту)

**Ожидаемый результат:**
- Webhook настроен корректно
- Включены все необходимые поля данных

---

### 5. Тестирование получения уведомлений в Telegram

**Тест 5.1: Отправка заявки с сайта**
**Действия:**
1. Заполните форму на сайте https://святобор.online
2. Заполните все поля (имя, телефон, email, услуга, адрес, сообщение)
3. Нажмите кнопку "Перезвоните мне"

**Ожидаемый результат:**
- Появляется уведомление "Заявка успешно отправлена!"
- Пользователь видит уведомление toast

---

**Тест 5.2: Проверка Telegram бота**
**Действия:**
1. Откройте Telegram
2. Найдите бота (по токену или ссылке из n8n)
3. Проверьте, что пришло уведомление о новой заявке

**Ожидаемый результат:**
- В Telegram приходит сообщение от бота
- Сообщение содержит:
  - Имя клиента
  - Телефон
  - Email
  - Услуга
  - Адрес
  - Сообщение

---

## ЧАСТЬ 3: Тестирование на продакшене

### 6. Проверка доступности сайта
**Действия:**
1. Откройте https://святобор.online
2. Прокрутите страницу вниз до секции "Свяжитесь с нами"
3. Проверьте, что форма отображается корректно

**Ожидаемый результат:**
- Сайт загружается без ошибок
- Форма отображается со всеми полями
- Нет ошибок в консоли браузера

---

### 7. Проверка контактных данных на сайте

**Действия:**
1. Проверьте телефон в шапке сайта: +7 (995) 169-38-88
2. Проверьте WhatsApp ссылку: https://wa.me/79883398963
3. Проверьте Email: берест@святобор.online
4. Проверьте адрес: Новороссийск и Краснодарский край
5. Проверьте время работы: Пн-Пт: 8:00 - 20:00, Сб-Вс: 9:00 - 18:00

**Ожидаемый результат:**
- Все контактные данные обновлены до актуальных

---

### 8. Проверка PM2 логов на сервере
**Действия:**
```bash
# Подключитесь к серверу через SSH
ssh root@ваш-сервер.timeweb.ru

# Проверьте логи приложения
npm exec pm2 logs svyatobor-landing --lines 50

# Или проверьте лог файлы
tail -f /var/log/svyatobor-out.log
tail -f /var/log/svyatobor-error.log
```

**Ожидаемый результат:**
- Нет критических ошибок
- Запросы к API обрабатываются успешно
- Заявки отправляются в n8n

---

## ЧАСТЬ 4: Регрессионное тестирование

### 9. Тестирование с различными браузерами
**Действия:**
1. Откройте форму в Chrome
2. Откройте форму в Firefox
3. Откройте форму в Safari (если доступен)
4. Откройте форму на мобильном устройстве

**Ожидаемый результат:**
- Форма работает во всех браузерах
- Валидация полей работает корректно
- Отправка заявки успешна

---

### 10. Тестирование медленного соединения
**Действия:**
1. Откройте инструменты разработчика в браузере (F12)
2. Установите медленное соединение (Network tab -> Throttling -> Slow 3G)
3. Попробуйте отправить форму

**Ожидаемый результат:**
- Кнопка "Перезвоните мне" блокируется на время отправки
- Отображается состояние "Отправка..."
- После завершения появляется сообщение об успехе

---

## ЧАСТЬ 5: Тестирование безопасности

### 11. Проверка защиты от XSS
**Действия:**
```bash
curl -X POST https://святобор.online/api/contact \
  -H "Content-Type: application/json" \
  -d '{
    "name": "<script>alert(\"XSS\")</script>",
    "phone": "+79991234567",
    "message": "<img src=x onerror=alert(\"XSS\")>"
  }'
```

**Ожидаемый результат:**
- Сервер не выполняет вредоносный код
- Данные сохраняются в зашифрованном/экранированном виде

---

### 12. Проверка защиты от CSRF
**Действия:**
- Проверьте, что API не использует простую проверку Origin
- Попробуйте отправить запрос с другого домена через curl

**Ожидаемый результат:**
- Запросы с подозрительных источников обрабатываются или отклоняются

---

## Критерии успешного тестирования

### Основные критерии
- ✅ Все API запросы возвращают корректные статусы (200 для успеха, 400 для ошибок валидации)
- ✅ Заявки успешно доставляются в n8n webhook
- ✅ Уведомления приходят в Telegram
- ✅ Контактные данные на сайте актуальны
- ✅ Нет ошибок в PM2 логах
- ✅ Форма работает на всех устройствах и браузерах

### Дополнительные критерии
- ✅ Время ответа API < 3 секунд
- ✅ Корректная обработка ошибок (пользователь видит понятные сообщения)
- ✅ Логи n8n содержат информацию о всех заявках
- ✅ Сайт доступен и работает стабильно

---

## Порядок выполнения тестов

### Рекомендуемая последовательность
1. **Шаг 0:** Убедитесь, что последний деплой прошел успешно
2. **Шаг 1:** Проверьте переменные окружения в GitHub Secrets
3. **Шаг 2:** Выполните тесты API через curl (ЧАСТЬ 1)
4. **Шаг 3:** Отправьте тестовую заявку с сайта (Тест 5.1)
5. **Шаг 4:** Проверьте n8n (ЧАСТЬ 2)
6. **Шаг 5:** Проверьте Telegram (Тест 5.2)
7. **Шаг 6:** Проверьте сайт и контактные данные (ЧАСТЬ 3)
8. **Шаг 7:** Проверьте PM2 логи (Тест 8)
9. **Шаг 8:** Проведите кроссбраузерное тестирование (ЧАСТЬ 4)
10. **Шаг 9:** Проведите тестирование безопасности (ЧАСТЬ 5)

---

## Отчет о тестировании

После выполнения всех тестов создайте отчет в формате:

```markdown
# Отчет о тестировании формы обратной связи

**Дата:** [дата]
**Тестировщик:** [имя]

## Результаты тестирования

### API Route (ЧАСТЬ 1)
- ✅/❌ OPTIONS запрос (CORS)
- ✅/❌ POST с валидными данными
- ✅/❌ POST без обязательных полей
- ✅/❌ POST с коротким телефоном
- ✅/❌ POST с невалидным email
- ✅/❌ POST с максимальными данными
- **Время ответа:** [среднее время]

### Интеграция с n8n (ЧАСТЬ 2)
- ✅/❌ Заявки появляются в n8n
- ✅/❌ Webhook настроен корректно
- **Время доставки заявки:** [среднее время]

### Уведомления Telegram (ЧАСТЬ 3)
- ✅/❌ Уведомления приходят в бота
- **Время доставки:** [среднее время]

### Продакшен (ЧАСТЬ 3)
- ✅/❌ Сайт доступен
- ✅/❌ Контактные данные актуальны
- ✅/❌ Нет ошибок в PM2 логах

### Кроссбраузерное тестирование (ЧАСТЬ 4)
- ✅/❌ Chrome
- ✅/❌ Firefox
- ✅/❌ Safari
- ✅/❌ Мобильные устройства

### Тестирование безопасности (ЧАСТЬ 5)
- ✅/❌ Защита от XSS
- ✅/❌ Защита от CSRF

## Общий вывод
[Описание общего состояния формы]
[Рекомендации по улучшению]

## Выявленные проблемы
- [Проблема 1]
- [Проблема 2]
- ...

## Решенные проблемы
- [Решение 1]
- [Решение 2]
- ...
```

---

## Дополнительные инструменты для тестирования

### Браузерные инструменты
- Chrome DevTools (F12) - Network tab для мониторинга запросов
- Firefox Developer Tools - для отладки
- Lighthouse - для проверки производительности

### Инструменты командной строки
- `curl` - для тестирования API
- `wget` - для проверки доступности
- `ssh` - для проверки логов на сервере

### Инструменты n8n
- Executions - для просмотра истории выполнений
- Workflow Editor - для настройки webhook
- Test Workflow - для тестирования n8n workflow

---

## Полезные ссылки
- n8n документация: https://docs.n8n.io
- Next.js API Routes: https://nextjs.org/docs/app/building-your-application/routing/route-handlers
- Zod валидация: https://zod.dev
- PM2 документация: https://pm2.keymetrics.io
