name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb Cloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci

    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build

    - name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏
      run: |
        ls -la out/
        test -f "out/index.html" && echo "‚úÖ index.html –Ω–∞–π–¥–µ–Ω" || echo "‚ùå index.html –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        test -f "out/404.html" && echo "‚úÖ 404.html –Ω–∞–π–¥–µ–Ω" || echo "‚ùå 404.html –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

    - name: üì§ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π Svyatobor Web..."

          # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
          BACKUP_DIR="backup/backup-$(date +%Y%m%d-%H%M%S)"
          mkdir -p backup
          cp -r /var/www/html "$BACKUP_DIR"
          echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_DIR"

          # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
          rm -rf /var/www/html/*
          echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

          # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
          mkdir -p /var/www/html/images
          mkdir -p /var/www/html/public/images

          echo "üìã –°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è:"
          echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–µ–ø–ª–æ—è: /var/www/html"
          echo "–î–æ–º–µ–Ω—ã: svyatobor.ru"

    - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ rsync
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          rsync -avz --delete ./out/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/html/
          echo "‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"

          # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          rsync -avz ./images/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/html/images/
          rsync -avz ./public/images/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/html/public/images/
          echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã"

    - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
          chmod -R 755 /var/www/html/
          find /var/www/html/ -type f -exec chmod 644 {} \;
          echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

    - name: üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
          sudo systemctl reload nginx
          sudo systemctl status nginx --no-pager
          echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–µ–ø–ª–æ—è:"

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          test -f "/var/www/html/index.html" && echo "‚úÖ index.html —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç" || echo "‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω"
          test -d "/var/www/html/images" && echo "‚úÖ –ü–∞–ø–∫–∞ images —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞" || echo "‚ùå –ü–∞–ø–∫–∞ images –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          test -d "/var/www/html/public/images" && echo "‚úÖ –ü–∞–ø–∫–∞ public/images —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞" || echo "‚ùå –ü–∞–ø–∫–∞ public/images –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
          du -sh /var/www/html/
          ls -la /var/www/html/ | head -10

          echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://${{ secrets.PRODUCTION_DOMAIN }}"

    - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/telegram-action@v0.3.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          üöÄ **–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**

          **–ü—Ä–æ–µ–∫—Ç:** Svyatobor Web
          **–í–µ—Ç–∫–∞:** ${{ github.ref_name }}
          **–ö–æ–º–º–∏—Ç:** ${{ github.sha }}
          **–í—Ä–µ–º—è:** $(date)

          üåê **–°–∞–π—Ç:** https://${{ secrets.PRODUCTION_DOMAIN }}

          üìä **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ