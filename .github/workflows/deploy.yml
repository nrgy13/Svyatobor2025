name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb Apps —Å PM2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci

    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build

    - name: üîé –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      shell: bash
      run: |
        set -eu
        show_presence() { [ -n "$1" ] && echo "set" || echo "missing"; }
        show_len() { [ -n "$1" ] && echo "${#1}" || echo "0"; }
        echo "SSH_HOST: $(show_presence "$SSH_HOST")"
        echo "SSH_USER: $(show_presence "$SSH_USER")"
        echo "SSH_PRIVATE_KEY length: $(show_len "$SSH_PRIVATE_KEY")"
        echo "PRODUCTION_DOMAIN: $(show_presence "$PRODUCTION_DOMAIN")"
        echo "TELEGRAM_BOT_TOKEN: $(show_presence "$TELEGRAM_BOT_TOKEN")"
        echo "TELEGRAM_CHAT_ID: $(show_presence "$TELEGRAM_CHAT_ID")"

    - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.SSH_HOST != '' &&
        env.SSH_USER != '' &&
        env.SSH_PRIVATE_KEY != ''
      shell: bash
      run: |
        set -eu
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.SSH_HOST != '' &&
        env.SSH_USER != '' &&
        env.SSH_PRIVATE_KEY != ''
      shell: bash
      run: |
        set -e
        echo "üîå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'EOF'
          set -e
          echo "1. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
          echo "2. –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js: $(node -v)"
          echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ npm: $(npm -v)"
        EOF

    - name: üì§ –î–µ–ø–ª–æ–π —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ SSH
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.SSH_HOST != '' &&
        env.SSH_USER != '' &&
        env.SSH_PRIVATE_KEY != ''
      shell: bash
      run: |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='node_modules' \
          . "$SSH_USER@$SSH_HOST:/var/www/html/"

    - name: üì§ –î–µ–ø–ª–æ–π PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.SSH_HOST != '' &&
        env.SSH_USER != '' &&
        env.SSH_PRIVATE_KEY != ''
      shell: bash
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'EOF'
          set -e

          cd /var/www/html

          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm ci --production

          echo "üì§ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 (–ª–æ–∫–∞–ª—å–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç)..."
          npm install --save-dev pm2

          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2..."
          ./node_modules/.bin/pm2 reload ecosystem.config.js || ./node_modules/.bin/pm2 start ecosystem.config.js

          echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2..."
          ./node_modules/.bin/pm2 save

          echo "‚úÖ PM2 —Å—Ç–∞—Ç—É—Å:"
          ./node_modules/.bin/pm2 status
        EOF

    - name: üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.SSH_HOST != '' &&
        env.SSH_USER != '' &&
        env.SSH_PRIVATE_KEY != ''
      shell: bash
      run: |
        rsync -avz \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./images/ "$SSH_USER@$SSH_HOST:/var/www/html/images/" || true
        rsync -avz \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./public/images/ "$SSH_USER@$SSH_HOST:/var/www/html/public/images/" || true

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.SSH_HOST != '' &&
        env.SSH_USER != '' &&
        env.SSH_PRIVATE_KEY != ''
      shell: bash
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–µ–ø–ª–æ—è:"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'EOF'
          echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ /var/www/html:"
          ls -la /var/www/html/
          echo ""
          echo "üîÑ –°—Ç–∞—Ç—É—Å PM2:"
          ./node_modules/.bin/pm2 status
          echo ""
          echo "üìä –õ–æ–≥–∏ PM2 (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
          ./node_modules/.bin/pm2 logs --lines 10 --nostream
        EOF
        echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        if [ -n "$PRODUCTION_DOMAIN" ]; then
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://$PRODUCTION_DOMAIN"
        fi

    - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ
      if: >
        github.ref == 'refs/heads/main' &&
        github.event_name == 'push' &&
        env.TELEGRAM_BOT_TOKEN != '' &&
        env.TELEGRAM_CHAT_ID != ''
      uses: appleboy/telegram-action@v1.0.1
      with:
        to: ${{ env.TELEGRAM_CHAT_ID }}
        token: ${{ env.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          üöÄ **–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**

          **–ü—Ä–æ–µ–∫—Ç:** Svyatobor Web
          **–í–µ—Ç–∫–∞:** ${{ github.ref_name }}
          **–ö–æ–º–º–∏—Ç:** ${{ github.sha }}

          üåê **–°–∞–π—Ç:** https://${{ env.PRODUCTION_DOMAIN }}

          üìä **PM2 —Å—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–ø—É—â–µ–Ω

          üéØ **API –º–∞—Ä—à—Ä—É—Ç—ã:** ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç
