name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb Apps

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci

    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: npm run build

    - name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏
      run: |
        ls -la out/
        test -f "out/index.html" && echo "‚úÖ index.html –Ω–∞–π–¥–µ–Ω" || echo "‚ùå index.html –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        test -f "out/404.html" && echo "‚úÖ 404.html –Ω–∞–π–¥–µ–Ω" || echo "‚ùå 404.html –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

    - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ SSH –∫–ª—é—á–∞ (–ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏):"
        head -n 2 ~/.ssh/deploy_key
        echo "üìã –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –≤–ª–∞–¥–µ–ª–µ—Ü:"
        stat ~/.ssh/deploy_key
        echo "üîå –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SSH:"
        ssh -vvv -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "1. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
          echo "2. –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "3. –ü—Ä–∞–≤–∞ –Ω–∞ /var/www/html:"
          ls -la /var/www/html/
          echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å:"
          touch /var/www/html/test_write && echo "‚úÖ –ó–∞–ø–∏—Å—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∞" || echo "‚ùå –ó–∞–ø–∏—Å—å –∑–∞–ø—Ä–µ—â–µ–Ω–∞"
        EOF

    - name: üì§ –î–µ–ø–ª–æ–π —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ SSH
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./out/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/html/

    - name: üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        rsync -avz \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./images/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/html/images/
        rsync -avz \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          ./public/images/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/html/public/images/

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–µ–ø–ª–æ—è:"
        ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "ls -la /var/www/html/"
        echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://${{ secrets.PRODUCTION_DOMAIN }}"

    - name: üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/telegram-action@v0.3.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        format: markdown
        message: |
          üöÄ **–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**

          **–ü—Ä–æ–µ–∫—Ç:** Svyatobor Web
          **–í–µ—Ç–∫–∞:** ${{ github.ref_name }}
          **–ö–æ–º–º–∏—Ç:** ${{ github.sha }}
          **–í—Ä–µ–º—è:** $(date)

          üåê **–°–∞–π—Ç:** https://${{ secrets.PRODUCTION_DOMAIN }}

          üìä **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ