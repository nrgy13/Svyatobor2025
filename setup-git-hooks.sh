#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Git Hooks Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ pre-commit, post-commit Ð¸ post-push Ñ…ÑƒÐºÐ¸

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Git Hooks Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ${NC}"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ñ…ÑƒÐºÐ¾Ð²
mkdir -p .git/hooks

# Pre-commit Ñ…ÑƒÐº - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
echo "ðŸ” Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽ Ð¿Ñ€ÐµÐ´ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð°
echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ESLint..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð°. Ð˜ÑÐ¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼."
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
echo "ðŸ”¨ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸..."
npm run build
if [ $? -ne 0 ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð´."
    exit 1
fi

echo "âœ… ÐŸÑ€ÐµÐ´ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹"
exit 0
EOF

# Post-commit Ñ…ÑƒÐº - ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
cat > .git/hooks/post-commit << 'EOF'
#!/bin/bash
echo "ðŸ“ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
echo "ðŸ’¡ Ð¡Ð¾Ð²ÐµÑ‚: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ 'git push' Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹"
EOF

# Post-push Ñ…ÑƒÐº - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÑƒÑˆÐ° Ð² production Ð²ÐµÑ‚ÐºÑƒ
cat > .git/hooks/post-push << 'EOF'
#!/bin/bash

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ‚ÐºÐ¸
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ðŸš€ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ push Ð² Ð²ÐµÑ‚ÐºÑƒ: $BRANCH"

# ÐÐ²Ñ‚Ð¾Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ production Ð²ÐµÑ‚ÐºÐ¸
if [ "$BRANCH" = "production" ]; then
    echo "ðŸŽ¯ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° production Ð²ÐµÑ‚ÐºÐ°. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð´ÐµÐ¿Ð»Ð¾Ð¹..."
    ./deploy.sh production

    if [ $? -eq 0 ]; then
        echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð² Slack/Telegram
    else
        echo "âŒ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹"
        exit 1
    fi
elif [ "$BRANCH" = "staging" ]; then
    echo "ðŸ§ª ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° staging Ð²ÐµÑ‚ÐºÐ°. Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² staging ÑÑ€ÐµÐ´Ñƒ..."
    ./deploy.sh staging
fi

exit 0
EOF

# Ð”ÐµÐ»Ð°ÐµÐ¼ Ñ…ÑƒÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼Ð¸
chmod +x .git/hooks/pre-commit
chmod +x .git/hooks/post-commit
chmod +x .git/hooks/post-push

echo -e "${GREEN}âœ… Git Hooks Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!${NC}"
echo ""
echo -e "${YELLOW}ðŸ“‹ ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ðµ Ñ…ÑƒÐºÐ¸:${NC}"
echo -e "  ðŸ” ${BLUE}pre-commit${NC} - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð° Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼"
echo -e "  ðŸ“ ${BLUE}post-commit${NC} - ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°"
echo -e "  ðŸš€ ${BLUE}post-push${NC} - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÑƒÑˆÐ° Ð² production Ð²ÐµÑ‚ÐºÑƒ"
echo ""
echo -e "${YELLOW}ðŸ”’ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ:${NC}"
echo -e "  â€¢ Ð¥ÑƒÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ ÐºÐ¾Ð´Ð°"
echo -e "  â€¢ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº"
echo -e "  â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ"